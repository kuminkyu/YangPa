<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="BoardMapper">
	
	<select id="getTel" parameterType="java.lang.String"
	resultType="java.lang.String">
	SELECT tel
	FROM mbr
	WHERE id = #{id}
	</select>
	
	<update id="viewCnt" parameterType="java.lang.String">
	UPDATE board
	SET view_cnt = view_cnt + 1
	WHERE bno = #{bno}
	</update>
	
	<select id="exdetail" parameterType="java.lang.String" resultType="co.kr.yangpa.board.BoardDTO">
	SELECT board.bno, mbr.id as writer, type.tname as type, board.title,
		board.contents, board.price, board.state, 
		date_format(write_date, '%Y/%c/%d') as write_date,
				board.view_cnt , addrmiddle.addrname, 
				excercise.buy_type,
			IF(excercise.buy_type = 0 , limit_date, limit_cnt) as useday
            , addrname ,addrdetail , addrgps
		FROM board
		INNER JOIN excercise
		ON board.bno = excercise.bno
		LEFT OUTER JOIN mbr
        on board.writer = mbr.mno
        LEFT OUTER JOIN type
        on board.type = type.tcode
        LEFT OUTER JOIN addrmiddle
        ON board.addrcode = addrmiddle.addrcode
		WHERE board.bno = #{bno} 
	</select>
	
	<select id="trdetail" parameterType="java.lang.String" resultType="co.kr.yangpa.board.BoardDTO">
	SELECT board.bno, mbr.id as writer, type.tname as type, board.title,
		board.contents, board.price, board.state, 
		date_format(write_date, '%Y/%c/%d') as write_date,
				board.view_cnt , addrmiddle.addrname, 
           checkin_date as useday , addrname ,addrdetail , addrgps
		FROM board
		INNER JOIN travel
		ON board.bno = travel.bno
		LEFT OUTER JOIN mbr
        on board.writer = mbr.mno
        LEFT OUTER JOIN type
        on board.type = type.tcode
        LEFT OUTER JOIN addrmiddle
        ON board.addrcode = addrmiddle.addrcode
		WHERE board.bno = #{bno} 
	</select>
	
	<select id="tidetail" parameterType="java.lang.String" resultType="co.kr.yangpa.board.BoardDTO">
	SELECT board.bno, mbr.id as writer, type.tname as type, board.title,
		board.contents, board.price, board.state, 
		date_format(write_date, '%Y/%c/%d') as write_date,
				board.view_cnt , addrmiddle.addrname, 
           ticket_date as useday , addrname ,addrdetail , addrgps
		FROM board
		INNER JOIN ticket
		ON board.bno = ticket.bno
		LEFT OUTER JOIN mbr
        on board.writer = mbr.mno
        LEFT OUTER JOIN type
        on board.type = type.tcode
        LEFT OUTER JOIN addrmiddle
        ON board.addrcode = addrmiddle.addrcode
		WHERE board.bno = #{bno} 
	</select>
	<select id="etcdetail" parameterType="java.lang.String" resultType="co.kr.yangpa.board.BoardDTO">
	SELECT board.bno, mbr.id as writer, type.tname as type, board.title,
		board.contents, board.price, board.state, 
		date_format(write_date, '%Y/%c/%d') as write_date,
				board.view_cnt , addrmiddle.addrname, 
				 addrname ,addrdetail , addrgps
		FROM board
		INNER JOIN etc
		ON board.bno = etc.bno
		LEFT OUTER JOIN mbr
        on board.writer = mbr.mno
        LEFT OUTER JOIN type
        on board.type = type.tcode
        LEFT OUTER JOIN addrmiddle
        ON board.addrcode = addrmiddle.addrcode
		WHERE board.bno = #{bno} 
	</select>


	<select id="searchAll" parameterType="co.kr.yangpa.board.SearchDTO"
		resultType="co.kr.yangpa.board.BoardDTO">
		SELECT board.bno, board.writer, type.tname as type, board.title, board.price, board.state, 
		date_format(write_date, '%Y/%c/%d') as write_date,
				board.view_cnt , addrmiddle.addrname, addrlarge.addrname as addrname2,
		<choose>
			<when test='typeno.equals("1")'>
			buy_type, 
			IF(excercise.buy_type = 0 , limit_date, limit_cnt) as useday
			</when>
			<when test='typeno.equals("2")'>checkin_date as useday</when>
			<when test='typeno.equals("3")'>ticket_date as useday</when>
			<when test='typeno.equals("4")'>limit_date as useday</when>
			<otherwise>"내용참조" as useday</otherwise>
		</choose> 				
		FROM board
    	<choose>
			<when test='typeno.equals("1")'>
	        	INNER JOIN excercise
				ON board.bno = excercise.bno
			</when>
			<when test='typeno.equals("2")'>
		        INNER JOIN travel
       			ON board.bno = travel.bno
			</when>
			<when test='typeno.equals("3")'>
	      	    INNER JOIN ticket
       			ON board.bno = ticket.bno
			</when>
			<when test='typeno.equals("4")'>
	      	    INNER JOIN etc
       			ON board.bno = etc.bno
			</when>
		</choose>
        LEFT OUTER JOIN type
        on board.type = type.tcode
        LEFT OUTER JOIN addrmiddle
        ON board.addrcode = addrmiddle.addrcode
        LEFT OUTER JOIN addrlarge
        ON left(board.addrcode,2) = addrlarge.addrcode
        ORDER BY bno DESC
        LIMIT #{reqNum} , 15  
         
	</select>
	
	<select id="searchEvery">
		select  board.bno , board.writer, type.tname as type, board.title,
		board.contents, board.price, board.state, buy_type, 
		IF(excercise.buy_type = 0 , limit_date, limit_cnt) as useday
		from board
		inner join excercise
		on board.bno = excercise.bno
        LEFT OUTER JOIN type
        ON board.type = type.tcode 
                LEFT OUTER JOIN addrmiddle
        ON board.addrcode = addrmiddle.addrcode ;
	</select>
	
	<select id="getOption" parameterType="java.lang.String" resultType="co.kr.yangpa.board.BoardDTO">
         SELECT tcode as option_code, tname as option_name 
         FROM type
         WHERE tcode LIKE CONCAT( #{typeno} ,'%')
	</select>
	
	<insert id="boardInsert" parameterType="co.kr.yangpa.board.BoardDTO">
		insert into board(writer, type ,title, contents, price , addrcode , 
				addrdetail , addrgps)
		values(#{writer} , #{type} , #{title} , #{contents} , #{price} , #{addrcode}
		      , #{addrdetail} , #{addrgps})		
	</insert>
	
	<insert id="exInsert" parameterType="co.kr.yangpa.board.BoardDTO">
		insert into excercise(bno, tcode, buy_type 
		<choose>
			<when test='buy_type.equals("0")'>
			, limit_date)
			</when>
			<when test='buy_type.equals("1")'>
			, limit_cnt)
			</when>
			<otherwise>,"insert 오류")</otherwise>
		</choose> 
		values(LAST_INSERT_ID() , #{type} , #{buy_type} ,#{useday})		
	</insert>
	
	<insert id="trInsert" parameterType="co.kr.yangpa.board.BoardDTO">
		insert into travel(bno, tcode, checkin_date) 
		values(LAST_INSERT_ID() , #{type} ,#{useday})		
	</insert>
	
	<insert id="tiInsert" parameterType="co.kr.yangpa.board.BoardDTO">
		insert into ticket(bno, tcode, ticket_date) 
		values(LAST_INSERT_ID() , #{type} ,#{useday})		
	</insert>
	
	<insert id="etcInsert" parameterType="co.kr.yangpa.board.BoardDTO">
		insert into etc(bno, type) 
		values(LAST_INSERT_ID() , #{type})		
	</insert>
	
	<select id="cmtList" parameterType="java.lang.String"
		resultType="co.kr.yangpa.board.BoardDTO">
	    SELECT mbr.mno as state , id as writer, bno , cnts as contents , write_date
	    FROM cmt
	    INNER JOIN mbr
	    ON cmt.mno = mbr.mno
	    WHERE bno = #{bno}
	</select>
	
	<insert id="cmtInsert" parameterType="co.kr.yangpa.board.BoardDTO">
		insert into cmt(mno , bno , cnts)
		values(#{writer} , #{bno} , #{contents})
	</insert>
	
</mapper>









